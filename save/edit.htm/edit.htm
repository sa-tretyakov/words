<!DOCTYPE html>
<html lang="en">
<head>
  <title>ESP Editor</title>
  <style type="text/css" media="screen">
   .contextMenu{z-index:300;position:absolute;left:5px;border:1px solid #444;background-color:#f5f5f5;display:none;box-shadow:0 0 10px rgba(0,0,0,.4);font-size:12px;font-family:sans-serif;font-weight:bold}
   .contextMenu ul{list-style:none;top:0;left:0;margin:0;padding:0}
   .contextMenu li{position:relative;min-width:60px;cursor:pointer}
   .contextMenu span{color:#444;display:inline-block;padding:6px}
   .contextMenu li:hover{background:#444}
   .contextMenu li:hover span{color:#EEE}
   .css-treeview ul,.css-treeview li{padding:0;margin:0;list-style:none}
   .css-treeview input{position:absolute;opacity:0}
   .css-treeview{font:normal 11px Verdana,Arial,Sans-serif;-moz-user-select:none;-webkit-user-select:none;user-select:none}
   .css-treeview span{color:#00f;cursor:pointer}
   .css-treeview span:hover{text-decoration:underline}
   .css-treeview input+label+ul{margin:0 0 0 22px}
   .css-treeview input ~ ul{display:none}
   .css-treeview label,.css-treeview label::before{cursor:pointer}
   .css-treeview input:disabled+label{cursor:default;opacity:.6}
   .css-treeview input:checked:not(:disabled) ~ ul{display:block}
   .css-treeview label,.css-treeview label::before{background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAACgCAYAAAAFOewUAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAApxJREFUeNrslM1u00AQgGdthyalFFOK+ClIIKQKyqUVQvTEE3DmAhLwAhU8QZoH4A2Q2gMSFace4MCtJ8SPBFwAkRuiHKpA6sRN/Lu7zG5i14kctaUqRGhGXnu9O/Pt7MzsMiklvF+9t2kWTDvyIrAsA0aKRRi1T0C/hJ4LUbt5/8rNpWVlp8RSr9J40b48fxFaTQ9+ft8EZ6MJYb0Ok+dnYGpmPgXwKIAvLx8vYXc5GdMAQJgQEkpjRTh36TS2U+DWW/D17WuYgm8pwJyY1npZsZKOxImOV1I/h4+O6vEg5GCZBpgmA6hX8wHKUHDRBXQYicQ4rlc3Tf0VMs8DHBS864F2YFspjgUYjKX/Az3gsdQd2eeBHwmdGWXHcgBGSkZXOXohcEXebRoQcAgjqediNY+AVyu3Z3sAKqfKoGMsewBeEIOPgQxxPJIjcGH6qtL/0AdADzKGnuuD+2tLK7Q8DhHHbOBW+KEzcHLuYc82MkEUekLiwuvVH+guQBQzOG4XdAb8EOcRcqQvDkY2iCLuxECJ43JobMXoutqGgDa2T7UqLKwt9KRyuxKVByqVXXqIoCCUCAqhUOioTWC7G4TQEOD0APy2/7G2Xpu1J4+lxeQ4TXBbITDpoVelRN/BVFbwu5oMMJUBhoXy5tmdRcMwymP2OLQaLjx9/vnBo6V3K6izATmSnMa0Dq7ferIohJhr1p01zrlz49rZF4OMs8JkX23vVQzYp+wbYGV/KpXKjvspl8tsIKCrMNAYFxj2GKS5ZWxg4ewKsJfaGMIY5KXqPz8LBBj6+yDvVP79+yDp/9F9oIx3OisHWwe7Oal0HxCAAAQgAAEIQAACEIAABCAAAQhAAAIQgAAEIAABCEAAAhCAAAQgwD8E/BZgAP0qhKj3rXO7AAAAAElFTkSuQmCC") no-repeat}
   .css-treeview label,.css-treeview span,.css-treeview label::before{display:inline-block;height:16px;line-height:16px;vertical-align:middle}
   .css-treeview label{background-position:18px 0}
   .css-treeview label::before{content:"";width:16px;margin:0 22px 0 0;vertical-align:middle;background-position:0 -32px}
   .css-treeview input:checked+label::before{background-position:0 -16px}
   #editor textarea {width: 100%;height: 100%;font-size: 14px;font-family: monospace;}
   @media screen and (-webkit-min-device-pixel-ratio:0){.css-treeview{-webkit-animation:webkit-adjacent-element-selector-bugfix infinite 1s}@-webkit-keyframes webkit-adjacent-element-selector-bugfix{from{padding:0}to{padding:0}}}
   #uploader{position:absolute;top:0;right:0;left:0;height:28px;line-height:24px;padding-left:10px;background-color:#444;color:#EEE}#tree{position:absolute;top:28px;bottom:0;left:0;width:200px;padding:8px}
   #editor,#preview{position:absolute;top:28px;right:0;bottom:0;left:200px}
   #preview{background-color:#EEE;padding:5px}
   .file-selected {background-color: #f0f0f0;font-weight: bold;}

   /* Custom syntax highlighting for words language */
   .ace_editor .ace_text-layer .ace_keyword { color: #00f; font-weight: bold; }
   .ace_editor .ace_text-layer .ace_keyword.operator { color: #888; }
   .ace_editor .ace_text-layer .ace_keyword.control { color: #000080; font-weight: bold; }
   .ace_editor .ace_text-layer .ace_identifier { color: #006699; }
   .ace_editor .ace_text-layer .ace_constant.numeric { color: #c00000; }
   .ace_editor .ace_text-layer .ace_constant.numeric.hex { color: #800080; }
   .ace_editor .ace_text-layer .ace_string { color: #008000; }
   .ace_editor .ace_text-layer .ace_comment { color: #888888; font-style: italic; }
   .ace_editor .ace_text-layer .ace_storage.type { color: #800080; font-weight: bold; }
   .ace_editor .ace_text-layer .ace_support.type { color: #800080; }
   .ace_editor .ace_text-layer .ace_support.constant { color: #b06000; font-weight: bold; }
   .ace_editor .ace_text-layer .ace_custom-colonblock { color: #1f3a5f !important; font-weight: 600; }
   .ace_editor .ace_text-layer .ace_punctuation { color: #555; }
  </style>
  <script>
   var urlXXX = 'http://192.168.211.181';
   if (window.location.search.substring(1).split("=")[1]) {
    urlXXX = 'http://'+window.location.search.substring(1).split("=")[1];
   } else {
    urlXXX = 'http://'+window.location.host;
   }

var currentFileEl = null;
var saveButtonEl = null;
var isDirty = false;

function markDirty() {
  isDirty = true;
  if (saveButtonEl) {
    saveButtonEl.innerHTML = 'Save (Click to save!)';
  }
}

function markClean() {
  isDirty = false;
  if (saveButtonEl) {
    saveButtonEl.innerHTML = 'Save';
  }
}

function highlightTreeFile(path) {
  if (!path) return;
  path = path.toLowerCase();
  if (currentFileEl) currentFileEl.classList.remove('file-selected');
  var el = document.getElementById(path);
  if (el) {
    el.classList.add('file-selected');
    currentFileEl = el;
  } else currentFileEl = null;
}

function createFileUploader(element, tree, editor){
  // ... (остаётся без изменений, пропущено для краткости) ...
  // Весь код uploader'а остался тем же — он не менялся.
  var xmlHttp;
  var input = document.createElement("input");
  input.type = "file";
  input.multiple = false;
  input.name = "data";
  document.getElementById(element).appendChild(input);
  var path = document.createElement("input");
  path.id = "upload-path";
  path.type = "text";
  path.name = "path";
  path.defaultValue = "/";
  document.getElementById(element).appendChild(path);
  var button = document.createElement("button");
  button.innerHTML = 'Upload';
  document.getElementById(element).appendChild(button);
  var mkdir = document.createElement("button");
  mkdir.innerHTML = 'MkDir';
  document.getElementById(element).appendChild(mkdir);
  var mkfile = document.createElement("button");
  mkfile.innerHTML = 'MkFile';
  document.getElementById(element).appendChild(mkfile);
  var mksave = document.createElement("button");
  mksave.innerHTML = 'Save';
  document.getElementById(element).appendChild(mksave);
  saveButtonEl = mksave;

  function httpPostProcessRequest(){
   if (xmlHttp.readyState == 4){
    if(xmlHttp.status != 200) alert("ERROR["+xmlHttp.status+"]: "+xmlHttp.responseText);
    else {
     tree.refreshPath(path.value);
    }
   }
  }
  function createPath(p){
   xmlHttp = new XMLHttpRequest();
   xmlHttp.onreadystatechange = httpPostProcessRequest;
   var formData = new FormData();
   formData.append("path", p);
   xmlHttp.open("PUT", urlXXX+"/edit");
   xmlHttp.send(formData);
  }

  mksave.onclick = function(e){
    editor.execCommand('saveCommand');
  };
  mkfile.onclick = function(e){
   if(path.value.indexOf(".") === -1) return;
   createPath(path.value);
   editor.loadUrl(path.value);
  };
  mkdir.onclick = function(e){
   if(path.value.length < 2) return;
   var dir = path.value
   if(dir.indexOf(".") !== -1){
    if(dir.lastIndexOf("/") === 0) return;
    dir = dir.substring(0, dir.lastIndexOf("/"));
   }
   createPath(dir);
  };
  button.onclick = function(e){
   if(input.files.length === 0){
    return;
   }
   xmlHttp = new XMLHttpRequest();
   xmlHttp.onreadystatechange = httpPostProcessRequest;
   var formData = new FormData();
   formData.append("data", input.files[0], path.value);
   xmlHttp.open("POST", urlXXX+"/edit");
   xmlHttp.send(formData);
  };
  input.onchange = function(e){
   if(input.files.length === 0) return;
   var filename = input.files[0].name;
   var ext = /(?:\.([^.]+))?$/.exec(filename)[1];
   var name = /(.*)\.[^.]+$/.exec(filename)[1];
   if(typeof name !== undefined){
    filename = name;
   }
   if(typeof ext !== undefined){
    if(ext === "html") ext = "htm";
    else if(ext === "jpeg") ext = "jpg";
    filename = filename + "." + ext;
   }
   if(path.value === "/" || path.value.lastIndexOf("/") === 0){
    path.value = "/"+filename;
   } else {
    path.value = path.value.substring(0, path.value.lastIndexOf("/")+1)+filename;
   }
  }
}

function createTree(element, editor){
  // ... (остаётся без изменений, пропущено для краткости) ...
  // Весь tree-код остался тем же.
  var preview = document.getElementById("preview");
  var treeRoot = document.createElement("div");
  treeRoot.className = "css-treeview";
  document.getElementById(element).appendChild(treeRoot);

  function loadDownload(path){
   document.getElementById('download-frame').src = path+"?download=true";
  }

  function loadPreview(path){
   document.getElementById("editor").style.display = "none";
   preview.style.display = "block";
   preview.innerHTML = '<img src="'+ urlXXX +path+'" style="max-width:100%; max-height:100%; margin:auto; display:block;" />';
  }

  function fillFolderMenu(el, path){
   var list = document.createElement("ul");
   el.appendChild(list);
   var action = document.createElement("li");
   list.appendChild(action);
   var isChecked = document.getElementById(path).checked;
   var expnd = document.createElement("li");
   list.appendChild(expnd);
   if(isChecked){
    expnd.innerHTML = "<span>Collapse</span>";
    expnd.onclick = function(e){
     document.getElementById(path).checked = false;
     if(document.body.getElementsByClassName('contextMenu').length > 0) document.body.removeChild(el);
    };
    var refrsh = document.createElement("li");
    list.appendChild(refrsh);
    refrsh.innerHTML = "<span>Refresh</span>";
    refrsh.onclick = function(e){
     var leaf = document.getElementById(path).parentNode;
     if(leaf.childNodes.length == 3) leaf.removeChild(leaf.childNodes[2]);
     httpGet(leaf, path);
     if(document.body.getElementsByClassName('contextMenu').length > 0) document.body.removeChild(el);
    };
   } else {
    expnd.innerHTML = "<span>Expand</span>";
    expnd.onclick = function(e){
     document.getElementById(path).checked = true;
     var leaf = document.getElementById(path).parentNode;
     if(leaf.childNodes.length == 3) leaf.removeChild(leaf.childNodes[2]);
     httpGet(leaf, path);
     if(document.body.getElementsByClassName('contextMenu').length > 0) document.body.removeChild(el);
    };
   }
   var upload = document.createElement("li");
   list.appendChild(upload);
   upload.innerHTML = "<span>Upload</span>";
   upload.onclick = function(e){
    var pathEl = document.getElementById("upload-path");
    if(pathEl){
     var subPath = pathEl.value;
     if(subPath.lastIndexOf("/") < 1) pathEl.value = path+subPath;
     else pathEl.value = path.substring(subPath.lastIndexOf("/"))+subPath;
    }
    if(document.body.getElementsByClassName('contextMenu').length > 0) document.body.removeChild(el);
   };
   var delFile = document.createElement("li");
   list.appendChild(delFile);
   delFile.innerHTML = "<span>Delete</span>";
   delFile.onclick = function(e){
    httpDelete(path);
    if(document.body.getElementsByClassName('contextMenu').length > 0) document.body.removeChild(el);
   };
  }

  function fillFileMenu(el, path){
   var list = document.createElement("ul");
   el.appendChild(list);
   var action = document.createElement("li");
   list.appendChild(action);
   if(isTextFile(path)){
    action.innerHTML = "<span>Edit</span>";
    action.onclick = function(e){
     editor.loadUrl(path);
     if(document.body.getElementsByClassName('contextMenu').length > 0) document.body.removeChild(el);
    };
   } else if(isImageFile(path)){
    action.innerHTML = "<span>Preview</span>";
    action.onclick = function(e){
     loadPreview(path);
     if(document.body.getElementsByClassName('contextMenu').length > 0) document.body.removeChild(el);
    };
   }
   var download = document.createElement("li");
   list.appendChild(download);
   download.innerHTML = "<span>Download</span>";
   download.onclick = function(e){
    loadDownload(path);
    if(document.body.getElementsByClassName('contextMenu').length > 0) document.body.removeChild(el);
   };
   var delFile = document.createElement("li");
   list.appendChild(delFile);
   delFile.innerHTML = "<span>Delete</span>";
   delFile.onclick = function(e){
    httpDelete(path);
    if(document.body.getElementsByClassName('contextMenu').length > 0) document.body.removeChild(el);
   };
  }

function showContextMenu(e, path, isfile){
  var old = document.querySelector('.contextMenu');
  if (old) old.parentNode.removeChild(old);

  var divContext = document.createElement("div");
  var scrollTop  = document.body.scrollTop ? document.body.scrollTop : document.documentElement.scrollTop;
  var scrollLeft = document.body.scrollLeft ? document.body.scrollLeft : document.documentElement.scrollLeft;
  var left = e.clientX + scrollLeft;
  var top  = e.clientY + scrollTop;

  divContext.className = 'contextMenu';
  divContext.style.display = 'block';
  divContext.style.left = left + 'px';
  divContext.style.top  = top  + 'px';

  if (isfile) fillFileMenu(divContext, path);
  else        fillFolderMenu(divContext, path);

  document.body.appendChild(divContext);

  function hideMenu(ev) {
    if (!divContext.contains(ev.target)) {
      if (divContext.parentNode) divContext.parentNode.removeChild(divContext);
      document.removeEventListener('click', hideMenu);
      document.removeEventListener('contextmenu', hideMenu);
    }
  }

  document.addEventListener('click', hideMenu);
  document.addEventListener('contextmenu', hideMenu);
}

  function createTreeLeaf(path, name, size){
   var leaf = document.createElement("li");
   leaf.id = (((path == "/")?"":path)+"/"+name).toLowerCase();
   var label = document.createElement("span");
   label.textContent = name.toLowerCase();
   leaf.appendChild(label);
leaf.onclick = function(e){
 if(isTextFile(leaf.id)){
   editor.loadUrl(leaf.id);
 } else if(isImageFile(leaf.id)){
   loadPreview(leaf.id);
 }
};
   leaf.oncontextmenu = function(e){
    e.preventDefault();
    e.stopPropagation();
    showContextMenu(e, leaf.id, true);
   };
   return leaf;
  }

  function createTreeBranch(path, name, disabled){
   var leaf = document.createElement("li");
   var check = document.createElement("input");
   check.type = "checkbox";
   check.id = (((path == "/")?"":path)+"/"+name).toLowerCase();
   if(typeof disabled !== "undefined" && disabled) check.disabled = "disabled";
   leaf.appendChild(check);
   var label = document.createElement("label");
   label.for = check.id;
   label.textContent = name.toLowerCase();
   leaf.appendChild(label);
   check.onchange = function(e){
    if(check.checked){
     if(leaf.childNodes.length == 3) leaf.removeChild(leaf.childNodes[2]);
     httpGet(leaf, check.id);
    }
   };
   label.onclick = function(e){
    if(!check.checked){
     check.checked = true;
     if(leaf.childNodes.length == 3) leaf.removeChild(leaf.childNodes[2]);
     httpGet(leaf, check.id);
    } else {
     check.checked = false;
    }
   };
   leaf.oncontextmenu = function(e){
    e.preventDefault();
    e.stopPropagation();
    showContextMenu(e, check.id, false);
   };
   return leaf;
  }

  function addList(parent, path, items){
   var list = document.createElement("ul");
   parent.appendChild(list);
   var ll = items.length;
   items.sort(function(a,b){return (a.name < b.name) ? 1 : ((b.name < a.name) ? -1 : 0);});
   for(var i = 0; i < ll; i++){
    var item = items[i];
    var itemEl;
    if(item.type === "file"){
     itemEl = createTreeLeaf(path, item.name, item.size);
    } else {
     itemEl = createTreeBranch(path, item.name);
    }
    list.appendChild(itemEl);
   }
  }

  function isTextFile(path){
   var ext = /(?:\.([^.]+))?$/.exec(path)[1];
   if(typeof ext !== undefined){
    switch(ext){
     case "txt":
     case "htm":
     case "html":
     case "js":
     case "json":
     case "c":
     case "h":
     case "cpp":
     case "css":
     case "xml":
     case "words":
     case "wrd":
      return true;
    }
   }
   return false;
  }

  function isImageFile(path){
   var ext = /(?:\.([^.]+))?$/.exec(path)[1];
   if(typeof ext !== undefined){
    switch(ext){
     case "png":
     case "jpg":
     case "gif":
     case "ico":
      return true;
    }
   }
   return false;
  }

  this.refreshPath = function(path){
   if(path.lastIndexOf('/') < 1){
    path = '/';
    treeRoot.removeChild(treeRoot.childNodes[0]);
    httpGet(treeRoot, "/");
   } else {
    path = path.substring(0, path.lastIndexOf('/'));
    var leaf = document.getElementById(path).parentNode;
    if(leaf.childNodes.length == 3) leaf.removeChild(leaf.childNodes[2]);
    httpGet(leaf, path);
   }
  };

  function delCb(path){
   return function(){
    if (xmlHttp.readyState == 4){
     if(xmlHttp.status != 200){
      alert("ERROR["+xmlHttp.status+"]: "+xmlHttp.responseText);
     } else {
      if(path.lastIndexOf('/') < 1){
       path = '/';
       treeRoot.removeChild(treeRoot.childNodes[0]);
       httpGet(treeRoot, "/");
      } else {
       path = path.substring(0, path.lastIndexOf('/'));
       var leaf = document.getElementById(path).parentNode;
       if(leaf.childNodes.length == 3) leaf.removeChild(leaf.childNodes[2]);
       httpGet(leaf, path);
      }
     }
    }
   }
  }

  function httpDelete(filename){
   xmlHttp = new XMLHttpRequest();
   xmlHttp.onreadystatechange = delCb(filename);
   var formData = new FormData();
   formData.append("path", filename);
   xmlHttp.open("DELETE", urlXXX+"/edit");
   xmlHttp.send(formData);
  }

  function getCb(parent, path){
   return function(){
    if (xmlHttp.readyState == 4){
     if(xmlHttp.status == 200) addList(parent, path, JSON.parse(xmlHttp.responseText));
    }
   }
  }

  function httpGet(parent, path){
   xmlHttp = new XMLHttpRequest(parent, path);
   xmlHttp.onreadystatechange = getCb(parent, path);
   xmlHttp.open("GET", urlXXX+"/list?dir=" + path +"&rand="+Math.random(), true);
   xmlHttp.send(null);
  }

  httpGet(treeRoot, "/");
  return this;
 }

function createEditor(element, file, lang, theme, type){
  function getLangFromFilename(filename){
   var lang = "plain";
   var ext = /(?:\.([^.]+))?$/.exec(filename)[1];
   if(typeof ext !== undefined){
    switch(ext){
    case "txt": 
    case "wrd":
    case "words":
      lang = "my_mode";
      break;
    case "htm": lang = "html"; break;
    case "js": lang = "javascript"; break;
    case "c": lang = "c_cpp"; break;
    case "cpp": lang = "c_cpp"; break;
    case "css":
    case "scss":
    case "php":
    case "html":
    case "json":
    case "xml":
     lang = ext;
   }
  }
  return lang;
 }

 if(typeof file === "undefined") file = "/index.htm";

 if(typeof lang === "undefined"){
  lang = getLangFromFilename(file);
 }

 if(typeof theme === "undefined") theme = "textmate";

 if(typeof type === "undefined"){
  type = "text/"+lang;
  if(lang === "c_cpp" || lang === "my_mode") type = "text/plain";
 }

 var xmlHttp = null;

   if(useAce){
 var editor = ace.edit(element);

 function httpPostProcessRequest(){
  if (xmlHttp.readyState == 4){
   if(xmlHttp.status != 200) alert("ERROR["+xmlHttp.status+"]: "+xmlHttp.responseText);
   else markClean();
  }
 }
 function httpPost(filename, data, type){
  xmlHttp = new XMLHttpRequest();
  xmlHttp.onreadystatechange = httpPostProcessRequest;
  var formData = new FormData();
  formData.append("data", new Blob([data], { type: type }), filename);
  xmlHttp.open("POST", urlXXX + "/edit");
  xmlHttp.send(formData);
 }
 function httpGetProcessRequest(){
  if (xmlHttp.readyState == 4){
   document.getElementById("preview").style.display = "none";
   document.getElementById("editor").style.display = "block";
   if(xmlHttp.status == 200) editor.setValue(xmlHttp.responseText);
   else editor.setValue("");
   editor.clearSelection();
   markClean();
  }
 }
 function httpGet(theUrl){
  xmlHttp = new XMLHttpRequest();
  xmlHttp.onreadystatechange = httpGetProcessRequest;
  if (theUrl.indexOf("/") == 0) theUrl = urlXXX + theUrl;
  xmlHttp.open("GET", theUrl+"?rand="+Math.random(), true);
  xmlHttp.send(null);
 }

 if(lang !== "plain") editor.getSession().setMode("ace/mode/"+lang);
 editor.setTheme("ace/theme/"+theme);
 editor.$blockScrolling = Infinity;
 editor.getSession().setUseSoftTabs(true);
 editor.getSession().setTabSize(2);
 editor.setHighlightActiveLine(true);
 editor.setShowPrintMargin(false);
 editor.getSession().on('change', function() { markDirty(); });
 editor.commands.addCommand({
  name: 'saveCommand',
  bindKey: {win: 'Ctrl-S',  mac: 'Command-S'},
  exec: function(editor) { httpPost(file, editor.getValue()+"", type); },
  readOnly: false
 });
 editor.commands.addCommand({
  name: 'undoCommand',
  bindKey: {win: 'Ctrl-Z',  mac: 'Command-Z'},
  exec: function(editor) { editor.getSession().getUndoManager().undo(false); },
  readOnly: false
 });
 editor.commands.addCommand({
  name: 'redoCommand',
  bindKey: {win: 'Ctrl-Shift-Z',  mac: 'Command-Shift-Z'},
  exec: function(editor) { editor.getSession().getUndoManager().redo(false); },
  readOnly: false
 });
 httpGet(file);
 editor.loadUrl = function(filename){
   var target = filename;
   function proceed(){
     file = target;
     if (window.highlightTreeFile) highlightTreeFile(file);
     lang = getLangFromFilename(file);
     type = "text/"+lang;
     if(lang !== "plain") editor.getSession().setMode("ace/mode/"+lang);
     httpGet(file);
   }
   if (window.isDirty && file !== target) {
     var msg = "The file has unsaved changes. Do you want to save it before opening another file?";
     var shouldSave = window.confirm(msg);
     if (shouldSave) {
       var xhr = new XMLHttpRequest();
       xhr.onreadystatechange = function(){
         if (xhr.readyState === 4) {
           if (xhr.status === 200) { markClean(); proceed(); }
           else alert("ERROR["+xhr.status+"]: " + xhr.responseText);
         }
       };
       var formData = new FormData();
       formData.append("data", new Blob([editor.getValue()+""], { type: type }), file);
       xhr.open("POST", urlXXX + "/edit");
       xhr.send(formData);
       return;
     }
   }
   proceed();
 };
 return editor;
 } else {
   var container = document.getElementById(element);
   container.innerHTML = '';
   var textarea = document.createElement("textarea");
   textarea.style.width = "100%";
   textarea.style.height = "100%";
   textarea.style.fontFamily = "monospace";
   container.appendChild(textarea);
   textarea.addEventListener('input', function() { markDirty(); });

   function saveCurrentText(callback){
     var xhr = new XMLHttpRequest();
     xhr.onreadystatechange = function(){
       if (xhr.readyState === 4) {
         if (xhr.status === 200) { markClean(); if (callback) callback(true); }
         else { alert("ERROR["+xhr.status+"]: " + xhr.responseText); if (callback) callback(false); }
       }
     };
     var formData = new FormData();
     formData.append("data", new Blob([textarea.value], { type: "text/plain" }), file);
     xhr.open("POST", urlXXX + "/edit");
     xhr.send(formData);
   }

   return {
     loadUrl: function(filename){
       var target = filename;
       function proceed(){
         file = target;
         var xhr = new XMLHttpRequest();
         xhr.open("GET", urlXXX + file + "?rand=" + Math.random(), true);
         xhr.onload = function(){
           textarea.value = (xhr.status === 200) ? xhr.responseText : "";
           markClean();
         };
         xhr.send();
       }
       if (window.isDirty && file !== target) {
         var msg = "The file has unsaved changes. Do you want to save it before opening another file?";
         var shouldSave = window.confirm(msg);
         if (shouldSave) {
           saveCurrentText(function(ok){ if (ok) proceed(); });
           return;
         }
       }
       proceed();
     },
     execCommand: function(cmd){
       if(cmd === 'saveCommand') saveCurrentText();
     }
   };
 }
}

function onBodyLoad(){
  var vars = {};
  var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m,key,value) { vars[key] = value; });
  if (typeof vars.url !== "undefined" && vars.url != "") urlXXX = "http://" + vars.url;
  var editor = createEditor("editor", vars.file, vars.lang, vars.theme);
  var tree = createTree("tree", editor);
  createFileUploader("uploader", tree, editor);
};
  </script>
  <script>
var useAce = false;

window.onload = function(){
  var aceScript = document.createElement("script");
  aceScript.src = "https://cdnjs.cloudflare.com/ajax/libs/ace/1.2.6/ace.js";
  aceScript.onload = function(){
    console.log("Ace loaded successfully");
    useAce = true;

    (function(){
      ace.define("ace/mode/my_highlight_rules", [
        "require","exports","module",
        "ace/lib/oop","ace/mode/text_highlight_rules"
      ], function (require, exports, module) {
        var oop = require("ace/lib/oop");
        var TextHighlightRules = require("ace/mode/text_highlight_rules").TextHighlightRules;

        var MyHighlightRules = function () {
          // Keywords that control flow or define things
          var keywords = "\\b(?:var|print|if|while|tcpBegin|tcpAccept|tcpReadArray|tcpWrite|tcpClose|tcp|main|script|set|voice|const|cont|rgb|seg|this|then)\\b";
          // Special commands
          var specialCommands = "\\+loop\\b";

          this.$rules = {
            start: [
              // Block comments /* ... */
              {
                token: "comment.block",
                regex: "/\\*",
                push: "block_comment"
              },
              // Line comments
              { token: "comment.line", regex: "//.*$" },
              { token: "comment.line", regex: "^\\s*#.*$" },
              { token: "comment.line", regex: "^\\s*;.*$" },

              // String literals
              {
                token: "string.quoted.double",
                regex: '"',
                push: "string"
              },

              // Colon block : name ... ;
              {
                token: "keyword.control",
                regex: ":",
                push: "colon_block"
              },

              // Special commands like +loop
              { token: "keyword.control", regex: specialCommands },

              // Numeric literals (including u16 suffix)
              { token: "constant.numeric.hex", regex: "\\b[0-9A-Fa-f]{6}\\b" },
              { token: "constant.numeric", regex: "\\b\\d+(?:u[0-9]+)?\\b" },

              // Types and built-in constants
              { token: "storage.type", regex: "\\barray\\b" },
              { token: "support.type", regex: "\\b(?:u8|u16|u32|i8|i16|i32)\\b" },
              { token: "support.constant", regex: "\\b(?:CRLF|CRLF2)\\b" },

              // Keywords
              { token: "keyword", regex: keywords },

              // Operators and punctuation
              { token: "keyword.operator", regex: "!=|==|<=|>=|\\+\\+|\\-\\-|\\+=|\\-=" },
              { token: "keyword.operator", regex: "[=+\\-*/<>!]" },
              { token: "punctuation", regex: "[{}();,\\[\\]]" },

              // Identifiers (variables, functions)
              { token: "identifier", regex: "[A-Za-z_][A-Za-z0-9_]*" },

              // Whitespace
              { token: "text", regex: "\\s+" }
            ],

            block_comment: [
              { token: "comment.block", regex: "\\*/", next: "pop" },
              { defaultToken: "comment.block" }
            ],

            string: [
              { token: "string.quoted.double", regex: '"', next: "pop" },
              { token: "constant.character.escape", regex: "\\\\." },
              { defaultToken: "string.quoted.double" }
            ],

            colon_block: [
              { token: "keyword.control", regex: ";", next: "pop" },
              { include: "start" } // или defaultToken, если Ace не поддерживает include
            ]
          };

          // Ace doesn't support "include", so we flatten colon_block
          this.$rules.colon_block = [
            { token: "keyword.control", regex: ";", next: "pop" },
            { token: "custom.colonblock", regex: ".+" }
          ];

          this.normalizeRules();
        };

        oop.inherits(MyHighlightRules, TextHighlightRules);
        exports.MyHighlightRules = MyHighlightRules;
      });

      ace.define("ace/mode/my_mode", [
        "require","exports","module",
        "ace/lib/oop","ace/mode/text","ace/mode/my_highlight_rules"
      ], function (require, exports, module) {
        var oop = require("ace/lib/oop");
        var TextMode = require("ace/mode/text").Mode;
        var MyHighlightRules = require("ace/mode/my_highlight_rules").MyHighlightRules;

        var Mode = function () {
          this.HighlightRules = MyHighlightRules;
        };
        oop.inherits(Mode, TextMode);

        (function () {
          this.lineCommentStart = ["#", ";", "//"];
          this.$id = "ace/mode/my_mode";
        }).call(Mode.prototype);

        exports.Mode = Mode;
      });
    })();

    onBodyLoad();
  };
  aceScript.onerror = function(){
    console.log("Ace failed to load, fallback mode");
    useAce = false;
    onBodyLoad();
  };
  document.head.appendChild(aceScript);
};
  </script>
</head>
<body>
  <div id="uploader"></div>
  <div id="tree"></div>
  <div id="editor"></div>
  <div id="preview" style="display:none;"></div>
  <iframe id="download-frame" style="display:none;"></iframe>
  <script>
    let ws;
    function connect(){
      ws = new WebSocket("ws://"+location.hostname+":82",["arduino"]);
      ws.onmessage = e => { c.value += e.data; c.scrollTop = c.scrollHeight; if (/cls/.test(e.data)){c.value = e.data} };
      ws.onclose = ws.onerror = () => setTimeout(connect, 2000);
    }
    connect();
    function sendCmd(e){
      if(e.keyCode===13){
        if (e.shiftKey) return;    
        e.preventDefault();
        let s = c.value.split("ok>").pop();
        ws.readyState===1 ? ws.send(s) : c.value+="\n[Нет соединения]\n";
      }
    }
  </script>
  <textarea id="c" cols="30" rows="30" style="width:30%;height:90%;position: absolute;top:26px;right:0;background-color:rgba(255, 255, 255, 0.5);border: 1px solid;" onkeypress="sendCmd(event)"></textarea>
</body>
</html>